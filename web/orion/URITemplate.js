define(function(){function c(a){this._text=a}function d(a,b){if(b==="U")return encodeURIComponent(a).replace(/[!'()*]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()});if(b==="U+R")return encodeURI(a).replace(/%5B/g,"[").replace(/%5D/g,"]");if(b==="U+R-,")return encodeURI(a).replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/,/g,"%2C");throw new Error("Unknown allowed character set: "+b)}function e(a,b,c){var e=[];for(var f=0;f<a.length;f++)typeof a[f]!="undefined"&&e.push(d(a[f],b));return e.join(c)}function f(a,b,c,e){var f=Object.keys(a),g=[];for(var h=0;h<f.length;h++)typeof a[f[h]]!="undefined"&&g.push(d(f[h],b)+c+d(a[f[h]],b));return g.join(e)}function g(a){var c=[],d=a.split(",");for(var e=0;e<d.length;e++){var f=d[e].match(b);if(f===null)throw new Error("Bad VarSpec: "+a);c.push({name:f[1],explode:!!f[2],prefix:f[3]?parseInt(f[3],10):-1})}return c}function h(b){if(b.length===0)throw new Error("Invalid Expression: 0 length expression");this._operator=a[b[0]],this._operator?b=b.substring(1):this._operator=a.NUL,this._varSpecList=g(b)}function i(a){var b=[],d=0,e=a.indexOf("{",d);while(e!==-1){b.push(new c(a.substring(d,e)));var f=a.indexOf("}",e+1);if(f===-1)throw new Error("Invalid template: "+a);b.push(new h(a.substring(e+1,f))),d=f+1,e=a.indexOf("{",d)}return b.push(new c(a.substring(d))),b}function j(a){this._templateComponents=i(a)}var a={NUL:{first:"",sep:",",named:!1,ifemp:"",allow:"U"},"+":{first:"",sep:",",named:!1,ifemp:"",allow:"U+R"},".":{first:".",sep:",",named:!1,ifemp:"",allow:"U"},"/":{first:"/",sep:"/",named:!1,ifemp:"",allow:"U"},";":{first:";",sep:";",named:!0,ifemp:"",allow:"U"},"?":{first:"?",sep:"&",named:!0,ifemp:"=",allow:"U"},"&":{first:"&",sep:"&",named:!0,ifemp:"=",allow:"U"},"#":{first:"#",sep:",",named:!1,ifemp:"",allow:"U+R"},",":{first:"",sep:",",named:!1,ifemp:"",allow:"U+R-,"}},b=/^((?:(?:[a-zA-Z0-9_])|(?:%[0-9A-F][0-9A-F]))(?:(?:[a-zA-Z0-9_.])|(?:%[0-9A-F][0-9A-F]))*)(?:(\*)|:([0-9]+))?$/;return c.prototype={expand:function(a){return encodeURI(this._text)}},h.prototype={expand:function(a){var b=[];for(var c=0;c<this._varSpecList.length;c++){var g=this._varSpecList[c],h=g.name,i=a[h],j=typeof i;if(j!=="undefined"&&i!==null){var k=b.length===0?this._operator.first:this._operator.sep;if(j==="string")this._operator.named&&(k+=d(h,"U+R"),k+=i.length===0?this._operator.ifemp:"="),g.prefix!==-1&&g.prefix<i.length&&(i=i.substring(0,g.prefix)),k+=d(i,this._operator.allow);else if(Array.isArray(i))g.explode?k+=e(i,this._operator.allow,this._operator.sep):(this._operator.named&&(k+=d(h,"U+R"),k+=i.length===0?this._operator.ifemp:"="),k+=e(i,this._operator.allow,","));else{if(j!=="object")throw new Error("bad param type: "+h+" : "+j);g.explode?k+=f(i,this._operator.allow,"=",this._operator.sep):(this._operator.named&&(k+=d(h,"U+R"),k+=Object.keys(i).length===0?this._operator.ifemp:"="),k+=f(i,this._operator.allow,",",","))}b.push(k)}}return b.join("")}},j.prototype={expand:function(a){var b=[];for(var c=0;c<this._templateComponents.length;c++)b.push(this._templateComponents[c].expand(a));return b.join("")}},j})